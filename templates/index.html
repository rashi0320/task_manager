<!DOCTYPE html>
<html>
  <head>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='style.css') }}"
    />
  </head>

  <body>
    <div class="header">
      <h2>Task Manager</h2>

      <div class="header-right">
        <span class="username">ðŸ‘¤ {{ username }}</span>
        <a href="/logout" class="logout-btn">Logout</a>
      </div>
    </div>

    <div class="top-controls">
      <button onclick="openModal()">Add +</button>
      <button id="deleteBtn" disabled onclick="deleteSelected()">Delete</button>
    </div>

    <div class="main">
      <!-- LEFT -->
      <div class="task-list">
        {% for task in tasks %}
        <div
          class="task-row"
          onclick="selectTask(this,'{{ task.content }}','{{ task.id }}')"
        >
          <input
            type="checkbox"
            value="{{ task.id }}"
            onchange="toggleDelete()"
          />

          <span>{{ task.content }}</span>
        </div>
        {% endfor %}
      </div>

      <!-- RIGHT -->
      <div class="task-detail">
        <div id="noTask" class="no-task">Select a task</div>

        <div id="editorBtns" style="display: none">
          <button onclick="saveTask()">Save</button>
          <button onclick="cancelEdit()">Cancel</button>
        </div>

        <textarea
          id="taskDetail"
          oninput="typing()"
          style="display: none"
        ></textarea>
      </div>
    </div>

    <!-- MODAL -->
    <div id="modal" onclick="closeModal()">
      <form
        action="/tasks"
        method="POST"
        class="modal-box"
        onclick="event.stopPropagation()"
      >
        <h3>Add Task</h3>

        <textarea
          name="task"
          placeholder="Write your task..."
          required
        ></textarea>

        <div class="modal-actions">
          <button type="submit" class="save-btn">Save</button>
          <button type="button" class="cancel-btn" onclick="closeModal()">
            Cancel
          </button>
        </div>
      </form>
    </div>

    <script>
      let originalText = "";

      function openModal() {
        document.getElementById("modal").style.display = "flex";
      }
      function closeModal() {
        document.getElementById("modal").style.display = "none";
      }

      function selectTask(el, text, id) {
        document
          .querySelectorAll(".task-row")
          .forEach((e) => e.classList.remove("active"));
        el.classList.add("active");

        document.getElementById("noTask").style.display = "none";
        document.getElementById("taskDetail").style.display = "block";

        document.getElementById("taskDetail").value = text;
        originalText = text;

        document.getElementById("currentTaskId").value = id;

        document.getElementById("editorBtns").style.display = "none";
        document.getElementById("deleteBtn").style.display = "inline-block";
      }

      function typing() {
        document.getElementById("editorBtns").style.display = "block";
        document.getElementById("deleteBtn").style.display = "none";
      }

      function cancelEdit() {
        document.getElementById("taskDetail").value = originalText;
        document.getElementById("editorBtns").style.display = "none";
        document.getElementById("deleteBtn").style.display = "inline-block";
      }

      function saveTask() {
        let id = document.getElementById("currentTaskId").value;
        let text = document.getElementById("taskDetail").value;

        fetch(`/tasks/${id}/update`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ content: text }),
        }).then(() => location.reload());
      }

      function toggleDelete() {
        let any = false;
        document.querySelectorAll("input[type=checkbox]").forEach((c) => {
          if (c.checked) any = true;
        });
        document.getElementById("deleteBtn").disabled = !any;
      }

      function deleteSelected() {
        let ids = [];

        document
          .querySelectorAll("input[type=checkbox]:checked")
          .forEach((c) => {
            ids.push(c.value);
          });

        fetch("/tasks/multi-delete", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ ids: ids }),
        }).then(() => location.reload());
      }
    </script>
  </body>
</html>
